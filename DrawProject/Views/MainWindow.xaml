<fluent:RibbonWindow
    x:Class="DrawProject.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:avalon="http://schemas.xceed.com/wpf/xaml/avalondock"
    xmlns:controls="clr-namespace:DrawProject.Controls"
    xmlns:converters="clr-namespace:DrawProject.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:fluent="urn:fluent-ribbon"
    xmlns:local="clr-namespace:DrawProject"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:DrawProject.ViewModels"
    Title="MainWindow"
    Width="900"
    Height="500"
    KeyDown="MainWindow_KeyDown"
    mc:Ignorable="d">

    <fluent:RibbonWindow.DataContext>
        <vm:MainViewModel />
    </fluent:RibbonWindow.DataContext>

    <fluent:RibbonWindow.Resources>
        <converters:ColorConverter x:Key="ColorConverter" />
        <converters:ObjectToBoolConverter x:Key="ObjectToBoolConverter" />
        <DropShadowEffect
            x:Key="DropShadowEffect"
            BlurRadius="10"
            Opacity="0.3"
            ShadowDepth="2"
            Color="Black" />
    </fluent:RibbonWindow.Resources>

    <fluent:RibbonWindow.InputBindings>
        <KeyBinding
            Key="N"
            Command="{Binding CreateCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="O"
            Command="{Binding OpenCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="S"
            Command="{Binding SaveCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="S"
            Command="{Binding SaveAsCommand}"
            Modifiers="Control+Shift" />
        <KeyBinding
            Key="R"
            Command="{Binding ResizeCommand}"
            Modifiers="Control" />
        <KeyBinding Key="Delete" Command="{Binding ClearCommand}" />
        <KeyBinding
            Key="N"
            Command="{Binding AddLayerCommand}"
            Modifiers="Control+Shift" />
        <KeyBinding
            Key="Delete"
            Command="{Binding RemoveLayerCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="OemCloseBrackets"
            Command="{Binding MoveLayerUpCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="OemOpenBrackets"
            Command="{Binding MoveLayerDownCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="D0"
            Command="{Binding ResetPanelSizesCommand, RelativeSource={RelativeSource AncestorType=fluent:RibbonWindow}}"
            Modifiers="Control" />
    </fluent:RibbonWindow.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Popup "О программе"  -->
        <Popup
            x:Name="aboutPopup"
            AllowsTransparency="True"
            IsOpen="False"
            Placement="Mouse"
            PopupAnimation="Slide"
            StaysOpen="False">
            <Border
                Width="350"
                Padding="20"
                Background="White"
                BorderBrush="#3A3A3A"
                BorderThickness="1"
                CornerRadius="8"
                Effect="{StaticResource DropShadowEffect}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <StackPanel
                        Grid.Row="0"
                        Margin="0,0,0,15"
                        Orientation="Horizontal">
                        <Image
                            Width="24"
                            Height="24"
                            Margin="0,0,10,0"
                            Source="/Icons/info.png" />
                        <TextBlock
                            FontSize="18"
                            FontWeight="SemiBold"
                            Foreground="#2C3E50"
                            Text="О программе" />
                    </StackPanel>
                    <StackPanel Grid.Row="1">
                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="16"
                            FontWeight="Bold"
                            Foreground="#2980B9"
                            Text="DrawProject" />
                        <TextBlock
                            Margin="0,0,0,10"
                            Foreground="#34495E"
                            Text="Векторно-растровый графический редактор" />
                        <Separator Margin="0,5,0,10" />
                        <StackPanel Margin="0,0,0,15">
                            <TextBlock Foreground="#2C3E50" Text="Версия: 1.0.0" />
                            <TextBlock Foreground="#2C3E50" Text="Сборка: Release 2024" />
                            <TextBlock Foreground="#2C3E50" Text="Дата сборки: 15.12.2024" />
                        </StackPanel>
                        <Separator Margin="0,5,0,10" />
                        <TextBlock
                            FontSize="11"
                            FontStyle="Italic"
                            Foreground="#7F8C8D"
                            Text="© 2024 DrawProject. Все права защищены." />
                        <TextBlock
                            Margin="0,5,0,0"
                            FontSize="11"
                            Foreground="#7F8C8D"
                            Text="Лицензия: MIT License" />
                    </StackPanel>
                </Grid>
            </Border>
        </Popup>

        <!--  Лента  -->
        <fluent:Ribbon
            x:Name="MainRibbon"
            Grid.Row="0"
            Height="Auto">
            <fluent:Ribbon.Resources>
                <Style TargetType="fluent:RibbonTabItem">
                    <Setter Property="Height" Value="Auto" />
                    <Setter Property="VerticalAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                </Style>
                <Style TargetType="fluent:RibbonGroupBox">
                    <Setter Property="Height" Value="Auto" />
                    <Setter Property="VerticalAlignment" Value="Stretch" />
                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                </Style>
            </fluent:Ribbon.Resources>

            <fluent:RibbonTabItem Height="Auto" Header="File">
                <fluent:RibbonGroupBox
                    Height="88"
                    Background="Gray"
                    Header="Document">
                    <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Background="White"
                            Command="{Binding CreateCommand}"
                            Header="New"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Background="White"
                            Command="{Binding OpenCommand}"
                            Header="Open"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Background="White"
                            Command="{Binding SaveCommand}"
                            Header="Save"
                            IsEnabled="{Binding CurrentDoc, Converter={StaticResource ObjectToBoolConverter}}"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Background="White"
                            Command="{Binding SaveAsCommand}"
                            Header="Save As"
                            IsEnabled="{Binding CurrentDoc, Converter={StaticResource ObjectToBoolConverter}}"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Background="White"
                            Command="{Binding ResizeCommand}"
                            Header="Resize"
                            IsEnabled="{Binding CurrentDoc, Converter={StaticResource ObjectToBoolConverter}}"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Background="White"
                            Click="ExitButton_Click"
                            Header="Exit"
                            SizeDefinition="Middle" />
                    </StackPanel>
                </fluent:RibbonGroupBox>
            </fluent:RibbonTabItem>

            <fluent:RibbonTabItem Height="Auto" Header="Layers">
                <fluent:RibbonGroupBox Height="Auto" Header="Manage">
                    <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Command="{Binding AddLayerCommand}"
                            Header="Add"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Command="{Binding RemoveLayerCommand}"
                            Header="Remove"
                            SizeDefinition="Middle" />
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Command="{Binding ClearCommand}"
                            Header="Clear"
                            SizeDefinition="Middle" />
                    </StackPanel>
                </fluent:RibbonGroupBox>
            </fluent:RibbonTabItem>

            <fluent:RibbonTabItem Height="Auto" Header="View">
                <fluent:RibbonGroupBox Height="Auto" Header="Layout">
                    <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Command="{Binding ResetPanelSizesCommand, RelativeSource={RelativeSource AncestorType=fluent:RibbonWindow}}"
                            Header="Reset"
                            SizeDefinition="Middle" />
                    </StackPanel>
                </fluent:RibbonGroupBox>
            </fluent:RibbonTabItem>

            <fluent:RibbonTabItem Height="Auto" Header="Tools">
                <fluent:RibbonGroupBox
                    x:Name="ToolsGroup"
                    Height="Auto"
                    Header="Tools">
                    <StackPanel
                        x:Name="ToolsPanel"
                        VerticalAlignment="Center"
                        Orientation="Horizontal" />
                </fluent:RibbonGroupBox>
            </fluent:RibbonTabItem>

            <fluent:RibbonTabItem Height="Auto" Header="Help">
                <fluent:RibbonGroupBox Height="Auto" Header="Info">
                    <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                        <fluent:Button
                            MinHeight="60"
                            Margin="2"
                            Click="OpenProgrammInfo"
                            Header="About"
                            SizeDefinition="Middle" />
                    </StackPanel>
                </fluent:RibbonGroupBox>
            </fluent:RibbonTabItem>
        </fluent:Ribbon>

        <!--  Единый DockingManager для всех панелей (обеспечивает перетаскивание)  -->
        <avalon:DockingManager x:Name="dockManager" Grid.Row="1">
            <avalon:DockingManager.Theme>
                <avalon:VS2010Theme />
            </avalon:DockingManager.Theme>

            <avalon:LayoutRoot>
                <avalon:LayoutPanel Orientation="Horizontal">

                    <!--  Левая панель (инструменты)  -->
                    <avalon:LayoutAnchorablePane DockMinWidth="150" DockWidth="2*">
                        <avalon:LayoutAnchorable
                            Title="Инструменты"
                            AutoHideWidth="200"
                            CanClose="False"
                            CanFloat="True"
                            CanHide="True"
                            ContentId="ToolsPane">
                            <controls:BrushControlPanel
                                ActiveTool="{Binding ActiveTool}"
                                BrushColor="{Binding CurrentBrush.Color, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                BrushSize="{Binding CurrentBrush.Size, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                CurrentDoc="{Binding CurrentDoc}"
                                MousePosition="{Binding MousePosition}" />
                        </avalon:LayoutAnchorable>
                    </avalon:LayoutAnchorablePane>

                    <!--  Центральная панель (холст)  -->
                    <avalon:LayoutDocumentPane DockMinWidth="300" DockWidth="5*">
                        <avalon:LayoutDocument
                            Title="Холст"
                            CanClose="False"
                            CanFloat="False"
                            ContentId="MainCanvas">
                            <Border
                                Background="#F8F8F8"
                                BorderBrush="LightGray"
                                BorderThickness="1">
                                <controls:ZoomBorder x:Name="zoomBorder">
                                    <controls:HybridCanvas
                                        x:Name="drawingCanvas"
                                        Width="{Binding CurrentDoc.Width}"
                                        Height="{Binding CurrentDoc.Height}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Brush="{Binding CurrentBrush}"
                                        ImageDocument="{Binding CurrentDoc}"
                                        Loaded="DrawingCanvas_Loaded"
                                        Tool="{Binding ActiveTool}" />
                                </controls:ZoomBorder>
                            </Border>
                        </avalon:LayoutDocument>
                    </avalon:LayoutDocumentPane>

                    <!--  Правая панель (слои)  -->
                    <avalon:LayoutAnchorablePane DockMinWidth="150" DockWidth="2*">
                        <avalon:LayoutAnchorable
                            Title="Слои"
                            AutoHideWidth="200"
                            CanClose="False"
                            CanFloat="True"
                            CanHide="True"
                            ContentId="LayersPane">
                            <controls:LayersPanelControl
                                AddLayerCommand="{Binding AddLayerCommand}"
                                Layers="{Binding Layers}"
                                MoveLayerDownCommand="{Binding MoveLayerDownCommand}"
                                MoveLayerUpCommand="{Binding MoveLayerUpCommand}"
                                RemoveLayerCommand="{Binding RemoveLayerCommand}"
                                SelectLayerCommand="{Binding SelectLayerCommand}"
                                SelectedLayerIndex="{Binding SelectedLayerIndex}" />
                        </avalon:LayoutAnchorable>
                    </avalon:LayoutAnchorablePane>

                </avalon:LayoutPanel>
            </avalon:LayoutRoot>
        </avalon:DockingManager>

    </Grid>
</fluent:RibbonWindow>