<Window
    x:Class="DrawProject.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:DrawProject.Controls"
    xmlns:converters="clr-namespace:DrawProject.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:DrawProject"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:DrawProject.ViewModels"
    Title="MainWindow"
    Width="834"
    Height="452"
    mc:Ignorable="d">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <converters:ColorConverter x:Key="ColorConverter" />
        <converters:ObjectToBoolConverter x:Key="ObjectToBoolConverter" />
        <DropShadowEffect
            x:Key="DropShadowEffect"
            BlurRadius="10"
            Opacity="0.3"
            ShadowDepth="2"
            Color="Black" />
    </Window.Resources>
    <Window.InputBindings>
        <!--  File  -->
        <KeyBinding
            Key="N"
            Command="{Binding CreateCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="O"
            Command="{Binding OpenCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="S"
            Command="{Binding SaveCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="S"
            Command="{Binding SaveAsCommand}"
            Modifiers="Control+Shift" />
        <KeyBinding
            Key="R"
            Command="{Binding ResizeCommand}"
            Modifiers="Control" />

        <!--  Edit / Layers  -->
        <KeyBinding Key="Delete" Command="{Binding ClearCommand}" />
        <KeyBinding
            Key="N"
            Command="{Binding AddLayerCommand}"
            Modifiers="Control+Shift" />
        <KeyBinding
            Key="Delete"
            Command="{Binding RemoveLayerCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="OemCloseBrackets"
            Command="{Binding MoveLayerUpCommand}"
            Modifiers="Control" />
        <!--  Ctrl+]  -->
        <KeyBinding
            Key="OemOpenBrackets"
            Command="{Binding MoveLayerDownCommand}"
            Modifiers="Control" />
        <!--  Ctrl+[  -->

        <!--  View  -->
        <KeyBinding
            Key="D0"
            Command="{Binding ResetPanelSizesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
            Modifiers="Control" />
        <!--  Ctrl+0  -->

        <!--  Tools (примеры - добавьте команды в ViewModel)  -->
        <KeyBinding Key="B" Command="{Binding SelectBrushToolCommand}" />
        <KeyBinding Key="E" Command="{Binding SelectEraserToolCommand}" />
        <KeyBinding Key="Space" Command="{Binding TogglePanModeCommand}" />

        <!--  Help  -->
        <KeyBinding Key="F1" Command="{Binding ShowAboutCommand}" />
    </Window.InputBindings>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <!--  Панель инструментов  -->
            <RowDefinition Height="*" />
            <!--  Основное содержимое  -->
        </Grid.RowDefinitions>

        <!--  === Popup "О программе" (остаётся как есть) ===  -->
        <Popup
            x:Name="aboutPopup"
            AllowsTransparency="True"
            IsOpen="False"
            Placement="Mouse"
            PopupAnimation="Slide"
            StaysOpen="False">
            <Border
                Width="350"
                Padding="20"
                Background="White"
                BorderBrush="#3A3A3A"
                BorderThickness="1"
                CornerRadius="8"
                Effect="{StaticResource DropShadowEffect}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <StackPanel
                        Grid.Row="0"
                        Margin="0,0,0,15"
                        Orientation="Horizontal">
                        <Image
                            Width="24"
                            Height="24"
                            Margin="0,0,10,0"
                            Source="/Icons/info.png" />
                        <TextBlock
                            FontSize="18"
                            FontWeight="SemiBold"
                            Foreground="#2C3E50"
                            Text="О программе" />
                    </StackPanel>
                    <StackPanel Grid.Row="1">
                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="16"
                            FontWeight="Bold"
                            Foreground="#2980B9"
                            Text="DrawProject" />
                        <TextBlock
                            Margin="0,0,0,10"
                            Foreground="#34495E"
                            Text="Векторно-растровый графический редактор" />
                        <Separator Margin="0,5,0,10" />
                        <StackPanel Margin="0,0,0,15">
                            <TextBlock Foreground="#2C3E50" Text="Версия: 1.0.0" />
                            <TextBlock Foreground="#2C3E50" Text="Сборка: Release 2024" />
                            <TextBlock Foreground="#2C3E50" Text="Дата сборки: 15.12.2024" />
                        </StackPanel>
                        <Separator Margin="0,5,0,10" />
                        <TextBlock
                            FontSize="11"
                            FontStyle="Italic"
                            Foreground="#7F8C8D"
                            Text="© 2024 DrawProject. Все права защищены." />
                        <TextBlock
                            Margin="0,5,0,0"
                            FontSize="11"
                            Foreground="#7F8C8D"
                            Text="Лицензия: MIT License" />
                    </StackPanel>
                </Grid>
            </Border>
        </Popup>

        <!--  === Верхняя панель инструментов ===  -->
        <ToolBar Grid.Row="0" Background="#F0F0F0">
            <DockPanel HorizontalAlignment="Stretch" LastChildFill="True">
                <!--  Левая часть: меню  -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                    <Menu>
                        <MenuItem Header="_File">
                            <MenuItem
                                Command="{Binding CreateCommand}"
                                Header="_New"
                                InputGestureText="Ctrl+N" />
                            <MenuItem
                                Command="{Binding OpenCommand}"
                                Header="_Open..."
                                InputGestureText="Ctrl+O" />
                            <MenuItem
                                Command="{Binding ResizeCommand}"
                                Header="_Resize..."
                                InputGestureText="Ctrl+R"
                                IsEnabled="{Binding CurrentDoc, Converter={StaticResource ObjectToBoolConverter}}" />
                            <MenuItem
                                Command="{Binding SaveCommand}"
                                Header="_Save"
                                InputGestureText="Ctrl+S"
                                IsEnabled="{Binding CurrentDoc, Converter={StaticResource ObjectToBoolConverter}}" />
                            <MenuItem
                                Command="{Binding SaveAsCommand}"
                                Header="Save _As..."
                                InputGestureText="Ctrl+Shift+S"
                                IsEnabled="{Binding CurrentDoc, Converter={StaticResource ObjectToBoolConverter}}" />
                            <Separator />
                            <MenuItem Header="E_xit" InputGestureText="Alt+F4" />
                        </MenuItem>

                        <MenuItem Header="_View">
                            <MenuItem
                                Command="{Binding ResetPanelSizesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                Header="_Reset Panels"
                                InputGestureText="Ctrl+0" />
                        </MenuItem>

                        <MenuItem Header="_Help">
                            <MenuItem
                                Command="{Binding ShowAboutCommand}"
                                Header="_About..."
                                InputGestureText="F1" />
                        </MenuItem>
                    </Menu>

                    <Menu>
                        <MenuItem x:Name="ToolBox" Header="Tools" />
                    </Menu>

                    <Menu>
                        <MenuItem Header="Layers">
                            <MenuItem Command="{Binding ClearCommand}" Header="Clear" />
                        </MenuItem>
                    </Menu>

                    <Menu>
                        <MenuItem Header="View">
                            <MenuItem Command="{Binding ResetPanelSizesCommand, RelativeSource={RelativeSource AncestorType=Window}}" Header="Сбросить панели" />
                        </MenuItem>
                    </Menu>
                </StackPanel>
            </DockPanel>
        </ToolBar>

        <!--  === Основное содержимое (3 колонки) ===  -->
        <!--  === Основное содержимое с регулируемыми панелями ===  -->
        <Grid x:Name="MainContentGrid" Grid.Row="1">
            <Grid.ColumnDefinitions>
                <!--  Левая панель (инструменты, цвета)  -->
                <ColumnDefinition
                    x:Name="LeftColumn"
                    Width="150"
                    MinWidth="80"
                    MaxWidth="300" />

                <!--  Левый разделитель  -->
                <ColumnDefinition Width="5" />

                <!--  Центр (холст)  -->
                <ColumnDefinition Width="*" MinWidth="200" />

                <!--  Правый разделитель  -->
                <ColumnDefinition Width="5" />

                <!--  Правая панель (слои)  -->
                <ColumnDefinition
                    x:Name="RightColumn"
                    Width="150"
                    MinWidth="100"
                    MaxWidth="250" />
            </Grid.ColumnDefinitions>

            <!--  Левая панель: цвет + размер кисти (БЕЗ ColumnSpan!)  -->
            <ScrollViewer
                Grid.Column="0"
                Margin="5"
                HorizontalScrollBarVisibility="Disabled"
                VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="5">
                    <Border
                        Margin="0,0,0,10"
                        Background="White"
                        BorderBrush="LightGray"
                        BorderThickness="1"
                        CornerRadius="3">
                        <TabControl BorderThickness="0" TabStripPlacement="Top">
                            <TabItem Header="RGBA">
                                <Border Padding="5">
                                    <Viewbox Stretch="Uniform">
                                        <controls:ColorSlider x:Name="ColorSliders" ColorChangedCommand="{Binding ColorWheelChanged}" />
                                    </Viewbox>
                                </Border>
                            </TabItem>
                            <TabItem Header="HSL">
                                <Border Padding="5">
                                    <Viewbox Stretch="Uniform">
                                        <controls:ColorSlider ColorChangedCommand="{Binding ColorWheelChanged}" />
                                    </Viewbox>
                                </Border>
                            </TabItem>
                        </TabControl>
                    </Border>

                    <Border
                        Padding="10,5"
                        Background="White"
                        BorderBrush="LightGray"
                        BorderThickness="1"
                        CornerRadius="3">
                        <StackPanel>
                            <TextBlock Margin="0,0,0,5" Text="Brush size:" />
                            <Slider
                                Maximum="100"
                                Minimum="1"
                                TickFrequency="5"
                                TickPlacement="BottomRight"
                                Value="{Binding BrushSize, Mode=TwoWay}">
                                <Slider.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Offset="0" Color="White" />
                                        <GradientStop Offset="1" Color="Black" />
                                    </LinearGradientBrush>
                                </Slider.Background>
                            </Slider>
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="12"
                                Text="{Binding BrushSize, StringFormat={}{0:F0}}" />
                        </StackPanel>
                    </Border>

                    <TextBlock
                        Margin="0,10,0,0"
                        Padding="8,5"
                        Background="#F8F8F8"
                        FontSize="11">
                        <Run Text="{Binding ActiveTool.Name, FallbackValue=Кисть}" />
                        <Run Foreground="#666666" Text=" (" />
                        <Run Text="{Binding MousePosition.X, StringFormat={}{0:F0}, FallbackValue=0}" />
                        <Run Text="," />
                        <Run Text="{Binding MousePosition.Y, StringFormat={}{0:F0}, FallbackValue=0}" />
                        <Run Foreground="#666666" Text=")" />
                    </TextBlock>

                    <TextBlock
                        Margin="0,0,0,10"
                        Padding="8,5"
                        Background="#F8F8F8"
                        FontSize="11">
                        <Run Foreground="#666666" Text="Размер: " />
                        <Run Text="{Binding CurrentDoc.Width, FallbackValue=0, StringFormat={}{0}×}" />
                        <Run Text="{Binding CurrentDoc.Height, FallbackValue=0}" />
                        <Run Foreground="#666666" Text=" px" />
                    </TextBlock>
                </StackPanel>
            </ScrollViewer>

            <!--  Левый разделитель  -->
            <GridSplitter
                Grid.Column="1"
                Width="5"
                HorizontalAlignment="Stretch"
                Background="#E0E0E0"
                Cursor="SizeWE" />

            <!--  Центр: холст (БЕЗ ColumnSpan!)  -->
            <Border
                Grid.Column="2"
                Margin="5"
                Background="#F8F8F8"
                BorderBrush="LightGray"
                BorderThickness="1">
                <controls:ZoomBorder x:Name="zoomBorder">
                    <controls:HybridCanvas
                        x:Name="drawingCanvas"
                        Width="{Binding CurrentDoc.Width}"
                        Height="{Binding CurrentDoc.Height}"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Brush="{Binding CurrentBrush}"
                        ImageDocument="{Binding CurrentDoc}"
                        Loaded="DrawingCanvas_Loaded"
                        Tool="{Binding ActiveTool}" />
                </controls:ZoomBorder>
            </Border>

            <!--  Правый разделитель  -->
            <GridSplitter
                Grid.Column="3"
                Width="5"
                HorizontalAlignment="Stretch"
                Background="#E0E0E0"
                Cursor="SizeWE" />

            <!--  Правая панель: слои  -->
            <Border
                Grid.Column="4"
                Margin="5"
                Background="White"
                BorderBrush="LightGray"
                BorderThickness="1">
                <DockPanel>
                    <Border
                        Padding="10,5"
                        Background="#F0F0F0"
                        BorderBrush="LightGray"
                        BorderThickness="0,0,0,1"
                        DockPanel.Dock="Top">
                        <TextBlock
                            HorizontalAlignment="Center"
                            FontWeight="Bold"
                            Text="Layers" />
                    </Border>

                    <StackPanel
                        Margin="5"
                        HorizontalAlignment="Center"
                        DockPanel.Dock="Bottom"
                        Orientation="Horizontal">
                        <Button
                            Width="30"
                            Command="{Binding AddLayerCommand}"
                            Content="+"
                            ToolTip="Add new layer" />
                        <Button
                            Width="30"
                            Margin="5,0,0,0"
                            Command="{Binding RemoveLayerCommand}"
                            Content="-"
                            ToolTip="Remove selected layer" />
                    </StackPanel>

                    <ListBox
                        x:Name="layersListBox"
                        BorderThickness="0"
                        ItemsSource="{Binding Layers}"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"
                        SelectedIndex="{Binding SelectedLayerIndex}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="2"
                                    Padding="3"
                                    Background="Transparent"
                                    CornerRadius="3">
                                    <DockPanel Height="40">
                                        <Border
                                            Width="30"
                                            Height="30"
                                            Margin="0,0,5,0"
                                            BorderBrush="#CCCCCC"
                                            BorderThickness="1"
                                            CornerRadius="3"
                                            DockPanel.Dock="Left">
                                            <Grid>
                                                <Rectangle Fill="White" />
                                                <Image Source="{Binding Source}" Stretch="UniformToFill" />
                                                <TextBlock
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    FontSize="9"
                                                    Foreground="Gray"
                                                    Text="IMG"
                                                    Visibility="{Binding Source, Converter={StaticResource ObjectToBoolConverter}}" />
                                            </Grid>
                                        </Border>

                                        <Button
                                            Padding="5,0"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Command="{Binding DataContext.SelectLayerCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}"
                                            Content="{Binding Name}">
                                            <Button.Style>
                                                <Style BasedOn="{StaticResource {x:Type Button}}" TargetType="Button">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="Transparent" CornerRadius="2">
                                                                    <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center" />
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="#F0F0F0" />
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </Button.Style>
                                        </Button>

                                        <StackPanel
                                            Width="25"
                                            DockPanel.Dock="Right"
                                            Orientation="Vertical">
                                            <Button
                                                Height="15"
                                                Command="{Binding DataContext.MoveLayerUpCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                CommandParameter="{Binding}"
                                                Content="↑"
                                                FontSize="8"
                                                ToolTip="Move up" />
                                            <Button
                                                Height="15"
                                                Margin="0,2,0,0"
                                                Command="{Binding DataContext.MoveLayerDownCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                CommandParameter="{Binding}"
                                                Content="↓"
                                                FontSize="8"
                                                ToolTip="Move down" />
                                        </StackPanel>
                                    </DockPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>

                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border Padding="{TemplateBinding Padding}" Background="{TemplateBinding Background}">
                                                <ContentPresenter />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter Property="Background" Value="#E3F2FD" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </DockPanel>
            </Border>
        </Grid>
    </Grid>
</Window>